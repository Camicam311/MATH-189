---
title: 'CASE STUDY 4:'
output: html_notebook
---

This study allows us to revisit/renew

1. Regression modeling
2. Properties of Least Squares/Fitting "a line"
3. Multiple observation

Datasets for this study are

1. The main file: gauge.txt
2. Supplementary large-scale files: download the following folder Full Resolution Data.zip More information about the supplementary file can be found at http://iabp.apl.washington.edu/data.html as well as http://nsidc.org/data/G00791


## Question
The aim of this lab is to provide a simple procedure for converting gain into density when the gauge is in operation. Keep in mind that the experiment was conducted by varying density and measuring the response in gain, but when the gauge is ultimately in use, the snow-pack density is to be estimated from the measured gain


## Setup
```{r}
df <- read.table('gauge-1wb1wa6-2gpel41.txt', header=TRUE)

#install.packages('L1pack')
library(L1pack)
```


## Scenario 1: Fitting
Use the data to fit the gain, or a transformation of gain, to density. Try sketching the least squares line on a scatter plot.

* Do the residuals indicate any problems with the fit?
* If the densities of the polyethylene blocks are not reported exactly, how might this affect the fit?
* What if the blocks of polyethylene were not measured in random order?
```{r}
# Plot raw data
title <- 'Density vs. Gain'
x.axis <- expression('Density (g/cm'^3*')')
y.axis <- 'Gain'
plot(df, main=title, xlab=x.axis, ylab=y.axis)


# Take log transformation of response variable (gain)
y.log.axis = 'log(Gain)'
df.log = data.frame(df['density'], log(df['gain']))
plot(df.log, main=title, xlab=x.axis, ylab=y.log.axis)


# Average replicate measurements
df.log.avg = aggregate(list(gain=df.log$gain), by=list(density=df.log$density), FUN=mean)
plot(df.log.avg, main=title, xlab=x.axis, ylab=y.log.axis)


# Fit gain to density
plot(df.log.avg, main=title, xlab=x.axis, ylab=y.log.axis)
least.squares <- lm(formula=gain~density, data=df.log.avg)
least.absolute.deviations <- lad(formula=gain~density, data=df.log.avg)
abline(least.squares, col='red')
abline(least.absolute.deviations, col='blue')


#least squares line
fit<-lm(data_cleaned$gain~data_cleaned$density)
summary(fit)
#standardized residual
fit.std<- rstandard(fit)
plot(data_cleaned, 
  	xlab="density", ylab="gain", 
   main="density vs gain")
#plot(raw$gain,residual)
abline(coefficients((fit)),lwd=2,lty=2,col="red")
yfit<-fit$fitted.values
resid<-data_cleaned$gain-yfit
plot(data_cleaned$density,resid)
#best fit line on a residual plot
abline(0,0,col="red")
#use qqplot to find the normality of residual
qqnorm(fit.std,ylab="Standardized Residuals",xlab="density")
qqline(fit.std)
#histogram for residuals
hist(xlab = "standard residuals",fit.std, main="histogram of residuals",prob=TRUE)
#normal curve
curve(dnorm(x, mean=mean(fit.std), sd=sd(fit.std)), add=TRUE,col="blue")
#empirical curve
lines(density(fit.std),col="red")
#add caption
legend("topright",legend=c("empirical curve","normal curve"),col=c("red","blue"),lty=1:1, cex=1)
```


## Scenario 2: Predicting
Ultimately we are interested in answering questions such as: Given a gain reading of 38.6, what is the density of the snow-pack? Given a gain reading of 426.7, what is the density of the snow-pack? These two numeric values, 38.6 and 426.7, were chosen because they are the average gains for the 0.508 and 0.001 densities, respectively.

* Develop a procedure for adding bands around your least squares line that can be used to make interval estimates for the snow-pack density from gain measurements. Keep in mind how the data were collected: several measurements of gain were taken for polyenythylene blocks of known density.
```{r}

```


## Scenario 3: Cross-Validation
To check how well your procedure works, omit the set of measurements corresponding to the block of density 0.508, apply your "estimation"/calibration procedure to the remaining data, and provide an interval estimate for the density of a block with an average reading of 38.6. Where does the actual density fall in the interval? Try the same test, for the set of measurements at the 0.001 density.
```{r}

```


## Additional Scenario: TODO Title
TODO Description.

Is it possible to run linear regression
```{r}

temp.1 <- read.csv('Full Resolution Data/145846.csv', header=TRUE)
temp.1 <- temp.1[,c('Hour','DOY','POS_DOY','Lat','Lon','Ts')]
temp.1 <- as.matrix(temp.1)
matrix.1 <- cor(temp.1)
matrix.1

table.total <- read.csv('Full Resolution Data/145846.csv', header=TRUE)

# Relationship between DOY and Ts from 10:00PM to 12:00AM
table.1 <- table.total[,c('DOY','Ts','Hour')]
table.1 <- table.1[which(table.1$Ts>-200 & table.1$Hour>22),]
fit <- lm(table.1$DOY ~ table.1$Ts)
yfit <- fit$fitted.values
#plot(table.1$Ts,fit$residuals)
plot(table.1$DOY, table.1$Ts)
abline(coefficients((fit)),lwd=2,lty=2,col="red")

# Relationship between Lat and Ts
#table.2 <- table.total[,c('Lat','Ts')]
#table.2 <- table.2[which(table.2$Ts>-200),]
#plot(table.2)


```